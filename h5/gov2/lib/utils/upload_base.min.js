!function(b){function a(e,c,d,f){alert(f)}b(".data-pic-contain .data-act-icon").unbind("click");b("body").delegate(".data-pic-contain .data-act-icon","click",function(){var d=b(b(this).closest(".pic_div").find('input[type="hidden"]')[0]);var e=b(b(this).closest(".pic_div").find(".needInput")[0]);if(d){var g=[];var c=[];var f=b(this).closest(".data-pic-contain");var h=b(this);f.fadeOut();setTimeout(function(){var i=h.closest(".pictype");f.remove();i.find("img").each(function(){g.push(b(this).attr("src"))});i.find(".data-need-input").each(function(){c.push(b(this).val())});d.val(g.join(";"));if(e.length>0){e.val(c.join(";"))}if(""!==b.trim(d.attr("data-max-num"))&&b.trim(d.attr("data-max-num"))>0&&g.length<parseInt(b.trim(d.attr("data-max-num")))){d.closest(".pic_div").find(".my-upload-btn").removeClass("disabled");d.closest(".pic_div").find(".input_file").removeClass("disabled")}},300)}});b(".data-pic-contain").find(".data-need-input").unbind("focusout");b("body").delegate(".data-pic-contain .data-need-input","focusout",function(){var d=b(b(this).closest(".pic_div").find(".needInput")[0]);if(d.length>0){var c=[];var e=b(this).closest(".pictype");e.find(".data-need-input").each(function(){c.push(b(this).val())});if(d.length>0){d.val(c.join(";"))}}});b.fn.upload_img=function(c,f){var d=b.extend({},b.fn.upload_img.defaults,c);var e;if(typeof f!="undefined"&&this.find(f)){e=this.find(f)}else{e=this}return e.each(function(){var t=this;var u=b(this).find(d.showImgEle);var o=b(b(this).find(d.hiddenEle)[0]);var g=b(b(this).find(".needInput")[0]);var r=b(this).find(d.fileEle);var j=b(this).find(d.showTipEle);var n=0;if(o&&o.val()){if(d.uploadType==="pic"){var s=o.val().split(";");if(d.needInput){var h=b(t).find(".needInput").val().split(";")}if(s&&s.length>0){var q=[];var m=[];var p;for(var l=0;l<s.length;l++){if(s[l]&&s[l].length>0){p='<div class="data-pic-contain" style="width:'+d.picW+';" data-pic-ind="'+l+'"><img src="'+s[l]+'"  /><div class="data-act-icon act-del" style="" data-pic-ind="'+l+'">×</div>';if(d.needInput){p+='<div class=""><input class="data-need-input form-control" type="text"  placeholder="'+d.inputTip+'" value="'+h[l]+'" /></div>';m.push(h[l])}p+="</div>";u.append(p);q.push(s[l]);n++}}o.val(q.join(";"));if(d.needInput){g.val(m.join(";"))}}}else{if(d.uploadType==="file"){var s=o.val().split(";");if(s&&s.length>0){var k=[];for(var l=0;l<s.length;l++){if(s[l]&&s[l].length>0){u.append('<span class="file_item_tip">'+s[l]+"</span>");k.push(s[l])}}o.val(k.join(";"))}}}}r.fileupload({url:d.url,dataType:"json",add:function(v,i){b(".content-wrapper").prepend(window.beastBase.loadingHtml);b(".loading-contain").css("display","block");b(t).find(".my-upload-btn").addClass("disabled");b(t).find(".input_file").addClass("disabled");i.submit()},done:function(w,v){console.log(v.jqXHR.responseJSON);b(".content-wrapper").find(".overlay-wrapper").remove();b(".loading-contain").css("display","none");b(t).find(".my-upload-btn").removeClass("disabled");b(t).find(".input_file").removeClass("disabled");if(v.jqXHR.responseJSON.error===null||v.jqXHR.responseJSON.errcode==0){var x=v.jqXHR.responseJSON.pic;var i="";if(d.uploadType==="pic"){i='<div class="data-pic-contain" style="width:'+d.picW+';" data-pic-ind="'+(n)+'"><img src="'+x+'"   onerror="this.onerror=null; this.src=\''+d.defaultPic+'\'; "/><div class="data-act-icon act-del" style="" data-pic-ind="'+(n++)+'">×</div>';if(d.needInput){i+='<div class="data-need-input"><input class="data-need-input form-control" type="text"  placeholder="'+d.inputTip+'" value="" /></div>'}i+="</div>"}else{if(d.uploadType==="file"){alert("操作成功！");i='<span class="file_item_tip">'+x+"</span>"}}if(d.isMulti){u.append(i);if(typeof o.val()==="undefined"||!o.val()||o.val()==""){o.val(x);g.val("")}else{o.val(o.val()+";"+x);g.val(g.val()+";")}if(""!==b.trim(o.attr("data-max-num"))&&b.trim(o.attr("data-max-num"))>0&&b.trim(o.attr("data-max-num"))<=o.val().split(";").length){b(t).find(".my-upload-btn").addClass("disabled");b(t).find(".input_file").addClass("disabled")}}else{u.html(i);o.val(x);g.val("")}if(d.callback){d.callback(t,x,d.callbackOption)}}else{a("#fc8383","#fc8383","#fbeded",v.jqXHR.responseJSON.errmsg)}},fail:function(v,i){a("#fc8383","#fc8383","#fbeded","请求失败")},progressall:function(v,i){}}).prop("disabled",!b.support.fileInput).parent().addClass(b.support.fileInput?undefined:"disabled")})};b.fn.upload_img.defaults={url:"/Api.php/common/Upload/uploadImgAjax",defaultPic:"../lib/images/upload_comn.png",showImgEle:".pictype",hiddenEle:'input[type="hidden"]',fileEle:".input_file",showTipEle:".tip_ele",uploadType:"pic",needInput:false,inputTip:"",isMulti:true,picW:"200px",picH:"200px",callback:false,callbackOption:{}}}(jQuery);picNum=0;function previewImage(d,f){var c=260;var b=180;if(d.files&&d.files[0]){f.append("<img id=imghead"+picNum+">");var e=document.getElementById("imghead"+picNum);e.onload=function(){var j=clacImgZoomParam(c,b,e.offsetWidth,e.offsetHeight);e.width=j.width;e.height=j.height;e.style.marginTop=j.top+"px"};var g=new FileReader();g.onload=function(j){e.src=j.target.result};g.readAsDataURL(d.files[0])}else{var h='filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale,src="';d.select();var a=document.selection.createRange().text;f.append("<img id=imghead"+picNum+">");var e=document.getElementById("imghead"+picNum);e.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=a;var i=clacImgZoomParam(c,b,e.offsetWidth,e.offsetHeight);status=("rect:"+i.top+","+i.left+","+i.width+","+i.height);f.append("<div id=divhead style='width:"+i.width+"px;height:"+i.height+"px;margin-top:"+i.top+"px;"+h+a+"\"'></div>")}picNum++}function clacImgZoomParam(d,c,b,a){var e={top:0,left:0,width:b,height:a};if(b>d||a>c){rateWidth=b/d;rateHeight=a/c;if(rateWidth>rateHeight){e.width=d;e.height=Math.round(a/rateWidth)}else{e.width=Math.round(b/rateHeight);e.height=c}}e.left=Math.round((d-e.width)/2);e.top=Math.round((c-e.height)/2);return e};